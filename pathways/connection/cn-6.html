<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#0d0906">
  <title>InnerShadow ‚Äì Building a Relational Life</title>
  <link rel="manifest" href="/manifest.json">
  <link rel="stylesheet" href="/css/main.css">
  <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;0,500;0,600;0,700;1,300;1,400;1,500&family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    html, body {
      position: fixed;
      width: 100%;
      height: 100%;
      overflow: hidden;
    }

    body {
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--bg-dark);
    }

    .shell {
      width: 100%;
      max-width: 28rem;
      height: 100vh;
      height: -webkit-fill-available;
      background: var(--bg-card);
      display: flex;
      flex-direction: column;
      position: relative;
      overflow: hidden;
      border-left: 1px solid var(--border-subtle);
      border-right: 1px solid var(--border-subtle);
    }

    .module-header {
      padding: max(1rem, env(safe-area-inset-top)) 1.25rem 0.875rem;
      background: rgba(10,15,30,0.95);
      border-bottom: 1px solid var(--border-subtle);
      flex-shrink: 0;
      z-index: 10;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }

    .module-header__row {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-bottom: 0.75rem;
    }

    .header-back {
      width: 2.25rem;
      height: 2.25rem;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--bg-card-light);
      border: 1px solid var(--border-soft);
      border-radius: 0.625rem;
      color: var(--text-primary);
      font-size: 1rem;
      cursor: pointer;
      transition: var(--transition-fast);
      flex-shrink: 0;
    }

    .header-back:active { transform: scale(0.92); }

    .header-title {
      flex: 1;
      font-size: 0.875rem;
      font-weight: 600;
      color: var(--text-primary);
      line-height: 1.3;
      text-align: center;
    }

    .header-count {
      font-size: 0.8125rem;
      color: var(--text-muted);
      font-weight: 500;
      min-width: 2.25rem;
      text-align: right;
    }

    .progress-dots { display: flex; gap: 0.3rem; }

    .progress-dot {
      flex: 1;
      height: 3px;
      background: rgba(148,163,184,0.15);
      border-radius: 999px;
      transition: background 0.4s ease;
    }

    .progress-dot--active { background: var(--gradient-main); }

    .module-scroll {
      flex: 1;
      overflow-y: auto;
      overflow-x: hidden;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
    }

    .module-scroll::-webkit-scrollbar { display: none; }

    .step-wrap { padding: 1.375rem 1.25rem 2rem; }

    .cta-area {
      padding: 1rem 1.25rem max(1rem, env(safe-area-inset-bottom));
      background: rgba(10,15,30,0.95);
      border-top: 1px solid var(--border-subtle);
      display: flex;
      gap: 0.75rem;
      align-items: center;
      flex-shrink: 0;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }

    .back-btn-sm {
      width: 3rem;
      height: 3rem;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--bg-card-light);
      border: 1px solid var(--border-soft);
      border-radius: 0.875rem;
      color: var(--text-secondary);
      font-size: 1.125rem;
      cursor: pointer;
      transition: var(--transition-fast);
      flex-shrink: 0;
    }

    .back-btn-sm:active { transform: scale(0.92); }
    .back-btn-sm:disabled { opacity: 0.3; cursor: default; }

    /* Harvard study finding cards */
    .finding-card {
      display: flex;
      gap: 1rem;
      align-items: flex-start;
      padding: 1rem 1.125rem;
      background: var(--bg-card-light);
      border: 1px solid var(--border-soft);
      border-radius: 1rem;
      margin-bottom: 0.625rem;
    }

    .finding-card__icon {
      font-size: 1.5rem;
      line-height: 1;
      flex-shrink: 0;
      margin-top: 0.125rem;
    }

    .finding-card__body { flex: 1; }

    .finding-card__title {
      font-size: 0.9375rem;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 0.3rem;
    }

    .finding-card__desc {
      font-size: 0.8125rem;
      color: var(--text-secondary);
      line-height: 1.55;
    }

    /* Drift causes */
    .drift-item {
      padding: 0.875rem 1rem;
      border-radius: 0.875rem;
      background: var(--bg-card-light);
      border: 1px solid var(--border-soft);
      margin-bottom: 0.5rem;
    }

    .drift-item__name {
      font-size: 0.875rem;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 0.25rem;
    }

    .drift-item__desc {
      font-size: 0.8125rem;
      color: var(--text-secondary);
      line-height: 1.55;
    }

    /* Toolkit integration rows */
    .toolkit-row {
      display: flex;
      align-items: flex-start;
      gap: 0.875rem;
      padding: 0.875rem 0;
      border-bottom: 1px solid var(--border-subtle);
    }

    .toolkit-row:last-child { border-bottom: none; }

    .toolkit-row__emoji {
      font-size: 1.375rem;
      line-height: 1;
      flex-shrink: 0;
      margin-top: 0.1rem;
    }

    .toolkit-row__body { flex: 1; }

    .toolkit-row__name {
      font-size: 0.875rem;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 0.2rem;
    }

    .toolkit-row__question {
      font-size: 0.8125rem;
      color: var(--text-muted);
      line-height: 1.45;
      margin-bottom: 0.375rem;
    }

    /* Complete screen ‚Äî pathway finish */
    .completion-hero {
      text-align: center;
      padding: 0.5rem 0 1.5rem;
    }

    .completion-orb {
      width: 6rem;
      height: 6rem;
      border-radius: 50%;
      background: var(--gradient-main);
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 1.25rem;
      font-size: 2.75rem;
      animation: float 3s ease-in-out infinite;
      box-shadow:
        0 0 60px rgba(13,148,136,0.4),
        0 0 120px rgba(13,148,136,0.15);
    }

    .completion-pathway-label {
      font-size: 0.75rem;
      font-weight: 700;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      color: var(--text-ember);
      margin-bottom: 0.625rem;
    }

    .completion-title {
      font-family: var(--font-display);
      font-size: 2.25rem;
      font-weight: 600;
      color: var(--text-primary);
      letter-spacing: -0.025em;
      line-height: 1.15;
      margin-bottom: 0.75rem;
    }

    .completion-title em {
      font-style: italic;
      color: var(--text-ember);
    }

    .completion-sub {
      font-size: 0.9375rem;
      color: var(--text-secondary);
      line-height: 1.7;
      max-width: 22rem;
      margin: 0 auto;
    }

    /* Stat chips */
    .stats-row {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 0.625rem;
      margin-bottom: 1.5rem;
    }

    .stat-chip {
      background: var(--bg-card-light);
      border: 1px solid var(--border-soft);
      border-radius: 1rem;
      padding: 0.875rem 0.5rem;
      text-align: center;
    }

    .stat-chip__num {
      font-family: var(--font-display);
      font-size: 1.75rem;
      font-weight: 600;
      color: var(--text-ember);
      line-height: 1;
      margin-bottom: 0.25rem;
    }

    .stat-chip__label {
      font-size: 0.6875rem;
      color: var(--text-muted);
      font-weight: 500;
      line-height: 1.4;
    }

    /* Earned tools list */
    .earned-tools {
      background: var(--gradient-card);
      border: 1px solid var(--border-soft);
      border-radius: 1.25rem;
      overflow: hidden;
      margin-bottom: 1.25rem;
    }

    .earned-tool-row {
      display: flex;
      align-items: center;
      gap: 0.875rem;
      padding: 0.9375rem 1.25rem;
      border-bottom: 1px solid var(--border-subtle);
      cursor: pointer;
      transition: var(--transition-fast);
    }

    .earned-tool-row:last-child { border-bottom: none; }
    .earned-tool-row:active { background: var(--ember-bg); }

    .earned-tool-row__emoji { font-size: 1.375rem; line-height: 1; flex-shrink: 0; }

    .earned-tool-row__body { flex: 1; }

    .earned-tool-row__name {
      font-size: 0.9375rem;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 0.15rem;
    }

    .earned-tool-row__tagline {
      font-size: 0.8125rem;
      color: var(--text-secondary);
    }

    .earned-tool-row__check {
      color: var(--text-ember);
      font-size: 0.9375rem;
      font-weight: 700;
    }

    /* Next pathway card */
    .next-pathway-card {
      background: linear-gradient(135deg,
        rgba(13,148,136,0.12),
        rgba(217,119,6,0.10));
      border: 1px solid var(--ember-border);
      border-radius: 1.25rem;
      padding: 1.375rem;
      margin-bottom: 1.25rem;
      cursor: pointer;
      transition: var(--transition-spring);
    }

    .next-pathway-card:hover  { transform: translateY(-2px); }
    .next-pathway-card:active { transform: scale(0.98); }

    .next-pathway-card__label {
      font-size: 0.75rem;
      font-weight: 700;
      letter-spacing: 0.07em;
      text-transform: uppercase;
      color: var(--text-ember);
      margin-bottom: 0.875rem;
    }

    .next-pathway-card__row {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .next-pathway-card__emoji {
      font-size: 2.5rem;
      line-height: 1;
      flex-shrink: 0;
    }

    .next-pathway-card__name {
      font-family: var(--font-display);
      font-size: 1.25rem;
      font-weight: 600;
      color: var(--text-primary);
      letter-spacing: -0.015em;
      margin-bottom: 0.25rem;
    }

    .next-pathway-card__name em {
      font-style: italic;
      color: var(--text-ember);
    }

    .next-pathway-card__desc {
      font-size: 0.8125rem;
      color: var(--text-secondary);
      line-height: 1.5;
    }

    .next-pathway-card__arrow {
      font-size: 1.25rem;
      color: var(--text-ember);
      margin-left: auto;
      flex-shrink: 0;
    }

    /* Closing quote */
    .closing-quote {
      text-align: center;
      padding: 1.25rem 0.5rem 0.5rem;
    }

    .closing-quote__text {
      font-family: var(--font-display);
      font-size: 1.0625rem;
      font-weight: 400;
      font-style: italic;
      color: var(--text-secondary);
      line-height: 1.75;
      margin-bottom: 0.625rem;
    }

    .closing-quote__attr {
      font-size: 0.8125rem;
      color: var(--text-muted);
    }

    @media (min-width: 640px) {
      .shell {
        height: 844px;
        max-height: 92vh;
        border-radius: 2.5rem;
        border: 1px solid var(--border-subtle);
      }
    }
  </style>
</head>
<body>
  <div class="shell">
    <div class="bg-orb bg-orb--ember"></div>
    <div class="bg-orb bg-orb--amber"></div>

    <div class="module-header">
      <div class="module-header__row">
        <button class="header-back" onclick="ModuleEngine.goBackToPathway()">‚Üê</button>
        <p class="header-title" id="moduleTitle">Building a Relational Life</p>
        <span class="header-count" id="stepCounter"></span>
      </div>
      <div class="progress-dots" id="progressDots"></div>
    </div>

    <div class="module-scroll" id="moduleScroll">
      <div class="step-wrap" id="stepContent"></div>
    </div>

    <div class="cta-area">
      <button class="back-btn-sm" id="backBtn" onclick="ModuleEngine.back()" disabled>‚Üê</button>
      <button class="btn btn--primary" id="nextBtn" onclick="ModuleEngine.next()">Continue</button>
    </div>
  </div>

  <div class="loading-overlay" id="loadingOverlay">
    <div class="loading-spinner"></div>
    <div class="loading-text" id="loadingText">Loading...</div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="/js/supabase-client.js"></script>
  <script src="/js/utils.js"></script>
  <script src="/js/module-engine.js"></script>
  <script>

  const B = ModuleEngine.Blocks;

  // ================================================================
  // MODULE CN-6: BUILDING A RELATIONAL LIFE
  // ================================================================

  const CN6_STEPS = [

    // ‚îÄ‚îÄ STEP 1: Intro ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    {
      type: 'intro',
      render: () => `
        ${B.heading('Five modules of skills. This one is about building the life where you can use them.')}
        ${B.para('You can have every connection skill in the world and still live in conditions that make connection nearly impossible ‚Äî too busy, too isolated, relationships that don\'t have the foundation for depth, no deliberate investment in what actually matters most.')}
        ${B.para('The Harvard Study of Adult Development is the longest-running study of human life in existence. The same people tracked from youth to old age ‚Äî across eight decades. Its conclusion, delivered by its director Robert Waldinger after reviewing seventy-five years of data:')}
        ${B.callout('"The clearest message we get from this seventy-five-year study is this: good relationships keep us happier and healthier. Period."')}
        ${B.para('Not wealth. Not fame. Not achievement. Not even health behaviours, which the relationships outpredicted. The quality of your relationships is the single strongest predictor of how well your life goes ‚Äî in happiness, in physical health, in longevity, in cognitive sharpness in old age.')}
        ${B.para('This final module is about designing the relational architecture of your life ‚Äî not hoping connection happens, but building the conditions where it actually can.')}
      `
    },

    // ‚îÄ‚îÄ STEP 2: Concept ‚Äî What the research says you need ‚îÄ‚îÄ
    {
      type: 'concept',
      render: () => `
        ${B.heading('What the research actually says you need.')}
        ${B.para('The Harvard study, along with decades of subsequent research across multiple longitudinal datasets, identified three specific relational qualities associated with wellbeing. Not quantity ‚Äî quality.')}

        <div style="margin-bottom:1.25rem">

          <div class="finding-card">
            <span class="finding-card__icon">ü§ù</span>
            <div class="finding-card__body">
              <p class="finding-card__title">At least one person you can be fully honest with</p>
              <p class="finding-card__desc">Someone who knows the real version ‚Äî not the performed one. Not what you say you feel, but what you actually feel. This single relationship is the strongest resilience predictor in the Harvard data. Waldinger calls it the "warm relationship" variable.</p>
            </div>
          </div>

          <div class="finding-card">
            <span class="finding-card__icon">üõü</span>
            <div class="finding-card__body">
              <p class="finding-card__title">A sense of reliable support</p>
              <p class="finding-card__desc">The belief ‚Äî tested and confirmed ‚Äî that if something went seriously wrong, someone would show up. Not that they'd solve it. That you wouldn't face it alone. This belief, independent of whether it's ever actually needed, predicts better health outcomes in its own right.</p>
            </div>
          </div>

          <div class="finding-card">
            <span class="finding-card__icon">‚òï</span>
            <div class="finding-card__body">
              <p class="finding-card__title">Regular positive contact</p>
              <p class="finding-card__desc">Not epic conversations ‚Äî ordinary moments of warmth, shared experience, being known. The accumulation of small positive exchanges matters more than the occasional deep conversation. Frequency, not intensity, is what sustains the relationship over time.</p>
            </div>
          </div>

        </div>

        ${B.insight('Quality over quantity', 'The study found that having many relationships of low quality produced worse wellbeing outcomes than having a few relationships of high quality. Social busyness is not the same thing as connection. The goal is not to be surrounded by people ‚Äî it\'s to be genuinely known by a few.')}
      `
    },

    // ‚îÄ‚îÄ STEP 3: Concept ‚Äî Why adult connection drifts ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    {
      type: 'concept',
      render: () => `
        ${B.heading('Why connection drifts ‚Äî and why it\'s not a character failure.')}
        ${B.para('Most adults\' social lives were built by accident ‚Äî assembled from proximity rather than intentional choice. The people you went to school with, worked next to, lived near. When those proximity structures changed, the connections often slowly dissolved.')}
        ${B.para('Adult friendship is structurally harder than childhood or adolescent friendship for one specific reason: it no longer happens by default. School provided daily contact, shared context, unscheduled time. Adult life provides none of those things automatically.')}

        <div style="display:flex;flex-direction:column;gap:0.5rem;margin-bottom:1.25rem">
          ${[
            ['The proximity collapse', 'After education ends, the automatic daily contact that created and maintained friendships disappears. Connection now requires deliberate effort that didn\'t used to be necessary ‚Äî and nobody tells you this is coming.'],
            ['The busyness trap', 'Work, family, logistics ‚Äî the urgent crowds out the important. Relationships feel like something to get to once everything else is handled. Everything else is never fully handled. The relationships slowly starve.'],
            ['The myth of effortless connection', 'The belief that real connection should happen naturally ‚Äî that if it requires scheduling, it\'s somehow less authentic. This belief is the single most common way adult friendships die. The scheduling is what keeps them alive.'],
            ['The comparison distortion', 'Scrolling through others\' apparent social abundance while underestimating the effort behind it. Most people\'s actual social lives are considerably lonelier than they look from the outside.'],
            ['The bid problem', 'Gottman identified "bids for connection" ‚Äî small moments when someone reaches toward you for contact or acknowledgment. In adult life, these happen through texts, brief calls, a shared observation. Missing them consistently is how distance builds without anyone intending it.']
          ].map(([name, desc]) => `
            <div class="drift-item">
              <p class="drift-item__name">${name}</p>
              <p class="drift-item__desc">${desc}</p>
            </div>
          `).join('')}
        </div>
      `
    },

    // ‚îÄ‚îÄ STEP 4: Concept ‚Äî The investment model ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    {
      type: 'concept',
      render: () => `
        ${B.heading('Connection is an investment, not an event.')}
        ${B.para('The research is consistent: the people who maintain close relationships in adult life don\'t do it through grand gestures or perfect timing. They do it through consistent small investments ‚Äî showing up, reaching out, being present, repairing early when things go slightly wrong.')}
        ${B.steps([
          '<strong>Scheduling is not less real.</strong> The dinner that\'s in the calendar happens. The dinner that\'s "we should do this sometime" doesn\'t. Putting people in your calendar is a form of valuing them ‚Äî not a bureaucratisation of friendship.',
          '<strong>Respond to bids.</strong> When someone reaches toward you with a text, an invitation, a shared observation ‚Äî respond. Not perfectly, not immediately always, but consistently. Bid response is the single most reliable predictor of relationship satisfaction in Gottman\'s research.',
          '<strong>Repair early.</strong> Distance accumulates when small ruptures go unaddressed. "I feel like we\'ve been out of sync lately" sent when you first notice it is infinitely easier than addressing six months of accumulated drift. The earlier the repair, the less it costs.',
          '<strong>Create the context for depth.</strong> Side-by-side activities ‚Äî walking, driving, cooking together ‚Äî tend to produce more honest conversation than face-to-face settings. Long meals, unscheduled time, late evenings. Depth doesn\'t appear on command; it requires the right conditions.',
          '<strong>Let it be ordinary.</strong> Relationships don\'t need to be consistently profound to be sustaining. The accumulation of mundane moments ‚Äî a brief call, a shared meal, a walk ‚Äî is what constitutes a relational life. Not every interaction needs to be meaningful.'
        ])}
      `
    },

    // ‚îÄ‚îÄ STEP 5: Worksheet ‚Äî Your relational landscape ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    {
      type: 'worksheet',
      render: () => `
        ${B.heading('Your relational landscape ‚Äî honestly.')}
        ${B.para('An audit of what the connection in your life actually looks like right now ‚Äî not what you wish it looked like.')}

        ${B.divider('What you have')}
        ${B.keyedTextarea('landscape-have', 'The relationships where I feel most genuinely connected are...', 'Who actually knows you? Who could you call at 2am? Who would you tell the real thing to? Be specific ‚Äî names or roles.', '80px')}

        ${B.divider('What\'s missing')}
        ${B.keyedTextarea('landscape-missing', 'What\'s most absent from my relational life right now is...', 'Not more people necessarily. What quality of connection? What kind of relationship? Someone to be fully honest with? Regular warmth? A sense of reliable support?', '80px')}

        ${B.divider('What\'s drifting')}
        ${B.keyedTextarea('landscape-drifted', 'A relationship I\'ve let drift that actually matters to me is...', 'Who have you lost touch with that you didn\'t intend to lose touch with? Who has become distant through accumulated inertia rather than any decision?', '75px')}

        ${B.divider('Where to invest')}
        ${B.keyedTextarea('landscape-invest', 'The relationship I most want to invest in right now is...', 'Not the one that needs the most fixing. The one with the most potential for real depth ‚Äî the one where a small investment would produce the most.', '70px')}
      `
    },

    // ‚îÄ‚îÄ STEP 6: Worksheet ‚Äî Toolkit integration ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    {
      type: 'worksheet',
      render: () => `
        ${B.heading('Bringing the five skills together.')}
        ${B.para('Across this pathway you\'ve built five specific tools. This step is about applying them ‚Äî not abstractly, but to the specific relationships in your life.')}

        <div style="
          background:var(--gradient-card);
          border:1px solid var(--border-soft);
          border-radius:1.25rem;
          padding:1.25rem;
          margin-bottom:1.25rem;
        ">
          ${[
            ['üåä', 'The Depth Shift',      'Which relationship will you use this in first? What would one level deeper look like with them?'],
            ['üëÇ', 'Deep Listening',        'Who in your life most needs you to actually listen ‚Äî not advise, not relate, just fully hear?'],
            ['üí¨', 'Honest Expression',     'What unsaid thing most needs to be said? To whom? When will you say it?'],
            ['‚ö°', 'Productive Conflict',   'What unresolved conflict is costing you most? What would a soft start-up sound like?'],
            ['üõ°', 'Limit Setting',         'What limit most needs to be stated clearly ‚Äî before resentment builds further?']
          ].map(([emoji, name, question]) => `
            <div class="toolkit-row">
              <span class="toolkit-row__emoji">${emoji}</span>
              <div class="toolkit-row__body">
                <p class="toolkit-row__name">${name}</p>
                <p class="toolkit-row__question">${question}</p>
                <textarea
                  class="step-textarea"
                  data-key="toolkit-${name.toLowerCase().replace(/\s+/g,'-')}"
                  placeholder="Your answer..."
                  style="
                    width:100%;
                    padding:0.625rem 0.75rem;
                    background:var(--bg-input);
                    border:1.5px solid var(--border-soft);
                    border-radius:0.75rem;
                    color:var(--text-primary);
                    font-size:14px;
                    font-family:var(--font-body);
                    line-height:1.55;
                    min-height:56px;
                    resize:vertical;
                    -webkit-appearance:none;
                  "
                  onfocus="this.style.borderColor='var(--ember-border-strong)'"
                  onblur="this.style.borderColor=''"
                ></textarea>
              </div>
            </div>
          `).join('')}
        </div>
      `
    },

    // ‚îÄ‚îÄ STEP 7: Worksheet ‚Äî The design ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    {
      type: 'worksheet',
      render: () => `
        ${B.heading('Designing your relational life.')}
        ${B.para('Connection in adult life doesn\'t happen by accident. It happens through deliberate architecture ‚Äî treating the relationships that matter as something you invest in on purpose, not something you get to once the urgent things are done.')}

        ${B.divider('The recurring investment')}
        ${B.keyedTextarea('design-recurring', 'The specific recurring investment I\'m making in my most important relationships is...', 'Not "spend more time with people." Specific: who, how often, what. A standing monthly dinner. A weekly call. A quarterly overnight. Something with a cadence it can be held to.', '85px')}

        ${B.divider('The context for depth')}
        ${B.keyedTextarea('design-depth', 'The context I\'m creating where deeper conversation can actually happen is...', 'Walking, driving, cooking together, long meals, unscheduled time. What conditions will you build in for conversations that can go somewhere?', '75px')}

        ${B.divider('The drift repair')}
        ${B.keyedTextarea('design-repair', 'The relationship I\'m going to reach out to this week to repair a drift is...', 'The person from step 5 who has drifted. What will you say? A simple "I\'ve been thinking about you, let\'s find a time" is enough to start.', '75px')}

        ${B.callout('Scheduling connection doesn\'t make it less real ‚Äî it makes it more likely to happen. Every strong adult friendship I\'ve seen is maintained by someone who decided the relationship mattered enough to be deliberate about it.')}
      `
    },

    // ‚îÄ‚îÄ STEP 8: Skill ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    {
      type: 'skill',
      render: () => `
        ${B.heading('Your sixth and final tool in this pathway.')}
        ${B.para('The practice that makes all the other skills usable ‚Äî building and maintaining the connections that matter, on purpose.')}
        ${B.skill(
          'Relational Investment Practice',
          'Build and maintain the connections that actually matter ‚Äî deliberately.',
          [
            '<strong>Know your circle.</strong> Who are the three to five people whose connection most matters to your wellbeing? These people get deliberate investment ‚Äî a recurring cadence, not just when you happen to have time.',
            '<strong>Create recurring structure.</strong> Weekly, fortnightly, monthly ‚Äî whatever the relationship can sustain. Put it in the calendar. Treat it with the same seriousness as any other commitment that actually matters.',
            '<strong>Respond to bids.</strong> When someone reaches toward you ‚Äî a text, an invitation, a shared observation ‚Äî respond. Not perfectly, but consistently. This is the smallest and most powerful investment available.',
            '<strong>Repair early.</strong> At the first sign of drift or friction ‚Äî reach. A brief "I feel like we\'ve been out of sync" sent when you first notice it costs almost nothing. Six months later it costs considerably more.',
            '<strong>Let it be imperfect and ordinary.</strong> Not every encounter needs to be meaningful. The accumulation of ordinary moments ‚Äî brief calls, shared meals, a walk ‚Äî is what a relational life actually consists of. Depth emerges from regularity, not from engineering the perfect conversation.'
          ]
        )}
        ${B.compare(
          'Passive approach: waiting for connection to happen naturally, assuming real friendship doesn\'t require effort, drifting from people who matter through accumulated inertia ‚Äî and wondering why you feel alone.',
          'Relational investment: deliberately calendaring the people who matter, responding to bids, repairing early, creating conditions for depth. The people in your life actually stay in your life.'
        )}
      `
    },

    // ‚îÄ‚îÄ STEP 9: Commitment ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    {
      type: 'commitment',
      render: () => `
        ${B.heading('Your final commitment in this pathway.')}
        ${B.para('The Harvard study\'s most important finding isn\'t about technique. It\'s about prioritisation. The people who maintained close relationships across the difficulty and busyness of adult life ‚Äî consistently, over decades ‚Äî had fundamentally different outcomes in every domain measured.')}
        ${B.para('Not because their lives were easier or their personalities more sociable. Because they decided their relationships were worth being deliberate about.')}
        ${B.commitment(
          'Write your relational investment commitment ‚Äî the specific recurring investment you\'re making, the relationships you\'re prioritising, and the first concrete action you\'re taking this week.',
          'My relational investment: I\'m going to invest in [specific relationships] by [specific recurring action ‚Äî monthly dinner / weekly call / etc.]. The first thing I\'m doing this week is [reaching out to / scheduling / saying the honest thing to]... The skill from this pathway I\'m leading with first is [tool] because...'
        )}
      `
    },

    // ‚îÄ‚îÄ STEP 10: Complete ‚Äî Full pathway finish ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    {
      type: 'complete',
      render: () => `
        <div class="completion-hero animate-fade-in">
          <div class="completion-orb">üåä</div>
          <p class="completion-pathway-label">Pathway complete</p>
          <h2 class="completion-title">Real<br><em>Connection</em></h2>
          <p class="completion-sub">Six modules. Six tools. A complete foundation for relationships that actually reach you.</p>
        </div>

        <div class="stats-row animate-fade-in">
          <div class="stat-chip">
            <div class="stat-chip__num">6</div>
            <div class="stat-chip__label">Modules<br>completed</div>
          </div>
          <div class="stat-chip">
            <div class="stat-chip__num">6</div>
            <div class="stat-chip__label">Tools<br>earned</div>
          </div>
          <div class="stat-chip">
            <div class="stat-chip__num" id="streakDisplay">‚Äì</div>
            <div class="stat-chip__label">Day<br>streak</div>
          </div>
        </div>

        <p style="font-size:0.75rem;font-weight:700;letter-spacing:0.07em;text-transform:uppercase;color:var(--text-muted);margin-bottom:0.875rem">
          Your earned toolkit
        </p>

        <div class="earned-tools animate-fade-in">
          ${[
            ['üåä', 'The Depth Shift',              'Move any conversation one level deeper'],
            ['üëÇ', 'Deep Listening',               'Hear to understand, not to respond'],
            ['üí¨', 'Honest Expression',            'Say what\'s true in a way that lands'],
            ['‚ö°', 'Productive Conflict',          'Navigate disagreement toward understanding'],
            ['üõ°', 'Limit Setting',               'Communicate what you need to stay'],
            ['‚ù§Ô∏è', 'Relational Investment Practice','Build the connections that matter ‚Äî on purpose']
          ].map(([emoji, name, tagline]) => `
            <div class="earned-tool-row" onclick="Nav.go('/app.html?tab=tools')">
              <span class="earned-tool-row__emoji">${emoji}</span>
              <div class="earned-tool-row__body">
                <p class="earned-tool-row__name">${name}</p>
                <p class="earned-tool-row__tagline">${tagline}</p>
              </div>
              <span class="earned-tool-row__check">‚úì</span>
            </div>
          `).join('')}
        </div>

        <p style="font-size:0.75rem;font-weight:700;letter-spacing:0.07em;text-transform:uppercase;color:var(--text-muted);margin-bottom:0.875rem">
          What's next
        </p>

        <div class="next-pathway-card animate-fade-in" onclick="Nav.go('/pathways/living/overview.html')">
          <p class="next-pathway-card__label">Final pathway ‚Äî now unlocked</p>
          <div class="next-pathway-card__row">
            <span class="next-pathway-card__emoji">üß≠</span>
            <div>
              <p class="next-pathway-card__name">Deliberate <em>Living</em></p>
              <p class="next-pathway-card__desc">Six modules on designing a life with intention ‚Äî not just surviving one.</p>
            </div>
            <span class="next-pathway-card__arrow">‚Üí</span>
          </div>
        </div>

        <div class="closing-quote animate-fade-in">
          <p class="closing-quote__text">"We are not the same persons this year as last; nor are those we love. It is a happy chance if we, changing, continue to love a changed person."</p>
          <p class="closing-quote__attr">W. Somerset Maugham</p>
        </div>

        <!-- Pathway feedback -->
        <div class="animate-fade-in" style="
          background:var(--bg-card-light);border:1px solid var(--border-soft);
          border-radius:1.25rem;padding:1.375rem;margin-bottom:1.25rem;text-align:left;
        ">
          <p style="font-size:0.8125rem;font-weight:700;letter-spacing:0.05em;text-transform:uppercase;color:var(--text-muted);margin-bottom:0.625rem">Help us build what's next</p>
          <p style="font-size:0.9375rem;color:var(--text-primary);line-height:1.65;margin-bottom:1rem">What would you want to go deeper on?</p>
          <div style="margin-bottom:0.875rem">
            ${['Romantic relationships','Loneliness','Family dynamics','Friendship','Breakups and loss','Conflict at work','Intimacy','Attachment patterns'].map(c => `
              <button onclick="toggleCn6Chip(this,'${c}')" style="
                display:inline-block;margin:0 0.375rem 0.375rem 0;
                padding:0.4375rem 0.9375rem;border-radius:999px;font-size:0.8125rem;
                font-family:Outfit,sans-serif;cursor:pointer;transition:all 0.18s ease;
                background:var(--bg-card);border:1.5px solid var(--border-soft);color:var(--text-secondary);
              ">${c}</button>
            `).join('')}
          </div>
          <textarea id="cn6FeedbackText" placeholder="Anything else you'd want to see? What brought you here?" style="
            width:100%;padding:0.75rem;background:var(--bg-card);
            border:1px solid var(--border-soft);border-radius:0.875rem;
            color:var(--text-primary);font-size:0.875rem;line-height:1.6;
            font-family:Outfit,sans-serif;resize:none;min-height:75px;box-sizing:border-box;margin-bottom:0.625rem;
          "></textarea>
          <button onclick="submitCn6Feedback()" id="cn6FeedbackBtn" style="
            width:100%;padding:0.75rem;background:rgba(217,95,53,0.1);
            border:1.5px solid rgba(217,95,53,0.3);border-radius:0.875rem;
            color:var(--text-ember);font-size:0.875rem;font-weight:600;
            font-family:Outfit,sans-serif;cursor:pointer;
          ">Send suggestions ‚Üí</button>
          <p id="cn6FeedbackThanks" style="display:none;text-align:center;font-size:0.875rem;color:var(--text-ember);font-weight:600;margin-top:0.75rem">‚úì Thank you ‚Äî this shapes what we build next</p>
        </div>

        <div style="display:flex;flex-direction:column;gap:0.75rem;padding-bottom:1rem">
          <button class="btn btn--primary btn--lg" onclick="Nav.go('/pathways/living/overview.html')">
            Begin Deliberate Living ‚Üí
          </button>
          <button class="btn btn--ghost btn--sm" onclick="Nav.go('/app.html')">
            Back to home
          </button>
        </div>
      `,
      afterRender: async () => {
        try {
          const session = await Auth.getSession();
          if (!session) return;
          const { data } = await DB.getUserState(session.user.id);
          const el = document.getElementById('streakDisplay');
          if (el && data?.streak_current) el.textContent = data.streak_current;
          UI.celebrate({ count: 120, spread: 90, origin: { y: 0.35 } });
        } catch (e) {}
      }
    }

  ];

  // ‚îÄ‚îÄ cn-6 feedback helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const cn6Chips = new Set();

  function toggleCn6Chip(el, chip) {
    const selected = cn6Chips.has(chip);
    if (selected) {
      cn6Chips.delete(chip);
      el.style.background = 'var(--bg-card)';
      el.style.borderColor = 'var(--border-soft)';
      el.style.color = 'var(--text-secondary)';
    } else {
      cn6Chips.add(chip);
      el.style.background = 'rgba(217,95,53,0.08)';
      el.style.borderColor = 'rgba(217,95,53,0.4)';
      el.style.color = 'var(--text-ember)';
    }
  }

  async function submitCn6Feedback() {
    const text  = document.getElementById('cn6FeedbackText')?.value?.trim();
    const chips = Array.from(cn6Chips);
    if (!text && !chips.length) return;
    document.getElementById('cn6FeedbackThanks').style.display = 'block';
    document.getElementById('cn6FeedbackBtn').disabled = true;
    try {
      const user = ModuleEngine.user;
      if (user) {
        await DB.saveFeedback({
          userId:     user.id,
          type:       'pathway_suggestions',
          pathwayKey: 'connection',
          chips:      chips.join(', '),
          text:       text || null,
          context:    'cn6_complete'
        });
      }
    } catch(e) {}
  }

  document.addEventListener('DOMContentLoaded', () => {
    ModuleEngine.init('cn-6', CN6_STEPS);
  });

  </script>

  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/sw.js').catch(() => {});
    }
  </script>
</body>
</html>
