<!DOCTYPE html>

<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#0a0f1e">
  <title>InnerShadow ‚Äì Let's find your starting place</title>
  <link rel="manifest" href="/manifest.json">
  <link rel="stylesheet" href="/css/main.css">
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,wght@0,300;0,400;0,500;0,600;0,700;1,300;1,400&family=Fraunces:ital,opsz,wght@0,9..144,300;0,9..144,400;0,9..144,500;1,9..144,300;1,9..144,400&display=swap" rel="stylesheet">
  <style>
    html, body {
      position: fixed;
      width: 100%;
      height: 100%;
      overflow: hidden;
    }

```
body {
  display: flex;
  align-items: center;
  justify-content: center;
  background: var(--bg-dark);
}

.shell {
  width: 100%;
  max-width: 28rem;
  height: 100vh;
  height: -webkit-fill-available;
  background: var(--bg-card);
  display: flex;
  flex-direction: column;
  position: relative;
  overflow: hidden;
  border-left: 1px solid var(--border-subtle);
  border-right: 1px solid var(--border-subtle);
}

/* Progress bar at very top */
.top-progress {
  height: 3px;
  background: var(--border-soft);
  flex-shrink: 0;
  position: relative;
  z-index: 10;
}

.top-progress__fill {
  height: 100%;
  background: var(--gradient-main);
  transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
}

/* Scroll area */
.scroll-area {
  flex: 1;
  overflow-y: auto;
  overflow-x: hidden;
  -webkit-overflow-scrolling: touch;
  scrollbar-width: none;
}

.scroll-area::-webkit-scrollbar { display: none; }

.inner {
  padding: max(1.75rem, env(safe-area-inset-top)) 1.5rem 2rem;
  min-height: 100%;
  display: flex;
  flex-direction: column;
}

/* Step counter */
.step-counter {
  font-size: 0.8125rem;
  font-weight: 600;
  color: var(--text-muted);
  letter-spacing: 0.05em;
  text-transform: uppercase;
  margin-bottom: 1.5rem;
}

.step-counter span {
  color: var(--text-teal);
}

/* Question block */
.question-block {
  flex: 1;
  display: flex;
  flex-direction: column;
}

.question-text {
  font-family: var(--font-display);
  font-size: 1.625rem;
  font-weight: 600;
  color: var(--text-primary);
  line-height: 1.25;
  letter-spacing: -0.015em;
  margin-bottom: 0.625rem;
}

.question-text em {
  font-style: italic;
  color: var(--text-teal);
}

.question-sub {
  font-size: 0.9375rem;
  color: var(--text-secondary);
  line-height: 1.6;
  margin-bottom: 1.75rem;
}

/* Options */
.options {
  display: flex;
  flex-direction: column;
  gap: 0.625rem;
  flex: 1;
}

.option {
  display: flex;
  align-items: flex-start;
  gap: 0.875rem;
  padding: 1rem 1.125rem;
  background: var(--bg-card-light);
  border: 2px solid var(--border-soft);
  border-radius: 1rem;
  cursor: pointer;
  transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
  text-align: left;
  width: 100%;
  font-family: var(--font-body);
  position: relative;
  overflow: hidden;
}

.option:hover {
  border-color: var(--teal-border);
  background: var(--teal-bg);
  transform: translateX(3px);
}

.option:active {
  transform: scale(0.98);
}

.option--selected {
  border-color: var(--teal-border-strong);
  background: var(--teal-bg-strong);
  transform: translateX(3px);
}

.option__emoji {
  font-size: 1.375rem;
  line-height: 1;
  flex-shrink: 0;
  margin-top: 0.0625rem;
}

.option__body {
  flex: 1;
  min-width: 0;
}

.option__label {
  font-size: 0.9375rem;
  font-weight: 600;
  color: var(--text-primary);
  line-height: 1.3;
  margin-bottom: 0.2rem;
}

.option__desc {
  font-size: 0.8125rem;
  color: var(--text-secondary);
  line-height: 1.5;
}

.option__check {
  width: 1.375rem;
  height: 1.375rem;
  border-radius: 50%;
  border: 2px solid var(--border-softer);
  flex-shrink: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s ease;
  margin-top: 0.0625rem;
}

.option--selected .option__check {
  background: var(--teal);
  border-color: var(--teal);
  color: white;
  font-size: 0.75rem;
}

/* Text input for Q5 */
.text-question {
  flex: 1;
  display: flex;
  flex-direction: column;
}

.big-textarea {
  flex: 1;
  min-height: 140px;
  width: 100%;
  padding: 1rem;
  background: var(--bg-input);
  border: 2px solid var(--border-soft);
  border-radius: 1rem;
  color: var(--text-primary);
  font-size: 1rem;
  font-family: var(--font-body);
  line-height: 1.65;
  resize: none;
  transition: var(--transition-base);
  -webkit-appearance: none;
}

.big-textarea::placeholder {
  color: var(--text-muted);
}

.big-textarea:focus {
  outline: none;
  border-color: var(--teal-border-strong);
  background: var(--bg-input-focus);
  box-shadow: 0 0 0 3px var(--teal-glow-soft);
}

.textarea-hint {
  font-size: 0.8125rem;
  color: var(--text-muted);
  margin-top: 0.5rem;
  line-height: 1.5;
}

/* CTA footer */
.cta-area {
  padding: 1.25rem 1.5rem max(1.25rem, env(safe-area-inset-bottom));
  background: rgba(10,15,30,0.95);
  border-top: 1px solid var(--border-subtle);
  display: flex;
  gap: 0.75rem;
  align-items: center;
  flex-shrink: 0;
}

.back-btn-sm {
  width: 3rem;
  height: 3rem;
  display: flex;
  align-items: center;
  justify-content: center;
  background: var(--bg-card-light);
  border: 1px solid var(--border-soft);
  border-radius: 0.875rem;
  color: var(--text-secondary);
  font-size: 1.125rem;
  cursor: pointer;
  transition: var(--transition-fast);
  flex-shrink: 0;
}

.back-btn-sm:active {
  transform: scale(0.92);
  background: var(--bg-card-medium);
}

.back-btn-sm:disabled {
  opacity: 0.3;
  cursor: default;
}

/* ‚îÄ‚îÄ RESULTS SCREEN ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */

.results-screen {
  display: none;
  flex-direction: column;
  height: 100%;
}

.results-screen--show {
  display: flex;
}

.results-scroll {
  flex: 1;
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
  scrollbar-width: none;
}

.results-scroll::-webkit-scrollbar { display: none; }

.results-inner {
  padding: max(2rem, env(safe-area-inset-top)) 1.5rem 2rem;
}

/* Pathway reveal card */
.pathway-reveal {
  text-align: center;
  padding: 2rem 1.5rem;
  background: linear-gradient(135deg,
    rgba(13,148,136,0.14),
    rgba(217,119,6,0.10));
  border: 1px solid var(--teal-border);
  border-radius: 1.25rem;
  margin-bottom: 1.25rem;
  animation: scale-in 0.4s ease-out;
}

.pathway-reveal__emoji {
  font-size: 3.5rem;
  line-height: 1;
  margin-bottom: 1rem;
  display: block;
  animation: float 3s ease-in-out infinite;
}

.pathway-reveal__label {
  font-size: 0.8125rem;
  font-weight: 700;
  letter-spacing: 0.08em;
  text-transform: uppercase;
  color: var(--text-teal);
  margin-bottom: 0.5rem;
}

.pathway-reveal__name {
  font-family: var(--font-display);
  font-size: 1.875rem;
  font-weight: 600;
  color: var(--text-primary);
  letter-spacing: -0.02em;
  line-height: 1.2;
  margin-bottom: 0.625rem;
}

.pathway-reveal__name em {
  font-style: italic;
  color: var(--text-teal);
}

.pathway-reveal__sub {
  font-size: 0.9375rem;
  color: var(--text-secondary);
  line-height: 1.6;
}

/* Reflection card */
.reflection-card {
  background: var(--gradient-card);
  border: 1px solid var(--border-soft);
  border-radius: 1.25rem;
  padding: 1.5rem;
  margin-bottom: 1.25rem;
  animation: fade-in-up 0.5s ease-out 0.2s both;
}

.reflection-card__label {
  font-size: 0.75rem;
  font-weight: 700;
  letter-spacing: 0.07em;
  text-transform: uppercase;
  color: var(--text-muted);
  margin-bottom: 0.875rem;
}

.reflection-card__text {
  font-size: 0.9375rem;
  color: var(--text-secondary);
  line-height: 1.8;
}

/* What's next preview */
.whats-next {
  animation: fade-in-up 0.5s ease-out 0.35s both;
  margin-bottom: 1.25rem;
}

.whats-next__label {
  font-size: 0.75rem;
  font-weight: 700;
  letter-spacing: 0.07em;
  text-transform: uppercase;
  color: var(--text-muted);
  margin-bottom: 0.875rem;
}

.first-module-card {
  display: flex;
  align-items: center;
  gap: 1rem;
  padding: 1rem 1.25rem;
  background: var(--teal-bg);
  border: 1px solid var(--teal-border-strong);
  border-radius: 1rem;
}

.first-module-card__num {
  width: 2.5rem;
  height: 2.5rem;
  background: var(--gradient-main);
  border-radius: 0.75rem;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 0.875rem;
  font-weight: 700;
  color: white;
  flex-shrink: 0;
}

.first-module-card__body { flex: 1; }

.first-module-card__title {
  font-size: 0.9375rem;
  font-weight: 600;
  color: var(--text-primary);
  margin-bottom: 0.15rem;
}

.first-module-card__sub {
  font-size: 0.8125rem;
  color: var(--text-teal);
}

.results-cta {
  padding: 1.25rem 1.5rem max(1.25rem, env(safe-area-inset-bottom));
  background: rgba(10,15,30,0.95);
  border-top: 1px solid var(--border-subtle);
  flex-shrink: 0;
  animation: fade-in-up 0.4s ease-out 0.5s both;
}

@media (min-width: 640px) {
  .shell {
    height: 844px;
    max-height: 92vh;
    border-radius: 2.5rem;
    border: 1px solid var(--border-subtle);
  }
}
```

  </style>
</head>
<body>
  <div class="shell">
    <div class="bg-orb bg-orb--teal"></div>
    <div class="bg-orb bg-orb--amber"></div>

```
<!-- Top progress bar -->
<div class="top-progress">
  <div class="top-progress__fill" id="topProgress" style="width:20%"></div>
</div>

<!-- Assessment questions -->
<div class="scroll-area" id="questionArea">
  <div class="inner">
    <p class="step-counter">Question <span id="stepNum">1</span> of 5</p>

    <div class="question-block" id="questionBlock">
      <!-- Rendered by JS -->
    </div>
  </div>
</div>

<!-- CTA -->
<div class="cta-area">
  <button class="back-btn-sm" id="backBtn" onclick="goBack()" disabled aria-label="Previous question">‚Üê</button>
  <button class="btn btn--primary" id="nextBtn" onclick="goNext()" disabled>
    Continue
  </button>
</div>

<!-- Results screen -->
<div class="results-screen" id="resultsScreen">
  <div class="results-scroll">
    <div class="results-inner">

      <div class="pathway-reveal">
        <span class="pathway-reveal__emoji" id="pathwayEmoji"></span>
        <p class="pathway-reveal__label">Your starting pathway</p>
        <h2 class="pathway-reveal__name" id="pathwayName"></h2>
        <p class="pathway-reveal__sub" id="pathwaySub"></p>
      </div>

      <div class="reflection-card">
        <p class="reflection-card__label">What we heard</p>
        <p class="reflection-card__text" id="reflectionText"></p>
      </div>

      <div class="whats-next">
        <p class="whats-next__label">Where you'll begin</p>
        <div class="first-module-card">
          <div class="first-module-card__num">1</div>
          <div class="first-module-card__body">
            <p class="first-module-card__title" id="firstModuleTitle"></p>
            <p class="first-module-card__sub" id="firstModuleTime">About 15 minutes</p>
          </div>
        </div>
      </div>

    </div>
  </div>

  <div class="results-cta">
    <button class="btn btn--primary btn--lg" id="startBtn" onclick="handleStart()">
      Begin my journey ‚Üí
    </button>
    <p style="text-align:center;font-size:0.8125rem;color:var(--text-muted);margin-top:0.75rem">
      You can explore all four pathways at any time
    </p>
  </div>
</div>
```

  </div><!-- /shell -->

  <div class="loading-overlay" id="loadingOverlay">
    <div class="loading-spinner"></div>
    <div class="loading-text" id="loadingText">Saving your results...</div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script src="/js/supabase-client.js"></script>

  <script src="/js/utils.js"></script>

  <script>

    // ================================================================
    // ASSESSMENT ENGINE
    // ================================================================

    // Current state
    let currentUser = null;
    let currentStep = 1;
    let answers     = {};
    let selectedVal = null;

    // ‚îÄ‚îÄ Question definitions ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

    const QUESTIONS = {

      1: {
        text:    'What brings you to <em>InnerShadow</em>?',
        sub:     'Choose the one that resonates most right now. There is no wrong answer.',
        type:    'choice',
        options: [
          {
            value: 'emotions',
            emoji: 'üåä',
            label: 'My emotions feel hard to manage',
            desc:  'Anxiety, numbness, reactions I can\'t control, feelings that overwhelm me'
          },
          {
            value: 'identity',
            emoji: 'ü™û',
            label: 'I don\'t really know who I am',
            desc:  'Unclear values, living for others, feeling like a stranger to myself'
          },
          {
            value: 'connection',
            emoji: 'üíî',
            label: 'My relationships don\'t feel real',
            desc:  'Loneliness, difficulty being close, patterns that keep repeating'
          },
          {
            value: 'heavy',
            emoji: 'üå´',
            label: 'Something feels heavy and I can\'t name it',
            desc:  'Life is working but something essential is missing'
          },
          {
            value: 'growth',
            emoji: 'üå±',
            label: 'I want to grow and understand myself better',
            desc:  'Things are okay ‚Äî I\'m here because I want more clarity and depth'
          }
        ]
      },

      // Q2 adapts based on Q1 ‚Äî five variants
      2: {
        emotions: {
          text:    'When your emotions feel hard, what does that usually look like?',
          sub:     'Pick the one that fits most closely.',
          type:    'choice',
          options: [
            {
              value: 'self-critical',
              emoji: 'ü™®',
              label: 'I\'m very hard on myself',
              desc:  'An inner critic that never lets up. High standards I can never quite meet'
            },
            {
              value: 'anxious',
              emoji: '‚ö°',
              label: 'My mind won\'t switch off',
              desc:  'Worry, overthinking, always scanning for what might go wrong'
            },
            {
              value: 'numb',
              emoji: 'üåë',
              label: 'I feel disconnected or numb',
              desc:  'Watching myself from a distance. Going through the motions'
            },
            {
              value: 'reactions',
              emoji: 'üî•',
              label: 'I react in ways I don\'t intend',
              desc:  'Something triggers me and I respond in ways I later regret'
            }
          ]
        },
        identity: {
          text:    'When you think about who you are, what feels most true?',
          sub:     'Pick the one that lands closest.',
          type:    'choice',
          options: [
            {
              value: 'others-expectations',
              emoji: 'üé≠',
              label: 'I\'ve been living up to others\' expectations',
              desc:  'My choices have been shaped more by what others want than what I want'
            },
            {
              value: 'lost',
              emoji: 'üß≠',
              label: 'I don\'t really know what I value or want',
              desc:  'When asked what I care about, I struggle to answer honestly'
            },
            {
              value: 'roles',
              emoji: 'ü™Ü',
              label: 'I play roles but don\'t know the real me',
              desc:  'Different versions of myself for different people ‚Äî none feel fully real'
            },
            {
              value: 'past',
              emoji: 'üîó',
              label: 'My past feels like it\'s defining me',
              desc:  'Old stories and experiences I can\'t seem to move beyond'
            }
          ]
        },
        connection: {
          text:    'What does connection feel like for you right now?',
          sub:     'Choose the description that fits most honestly.',
          type:    'choice',
          options: [
            {
              value: 'lonely-surrounded',
              emoji: 'üèô',
              label: 'I feel alone even around people',
              desc:  'Surface-level interactions that never quite become real'
            },
            {
              value: 'walls',
              emoji: 'üß±',
              label: 'I keep people at a distance',
              desc:  'Something stops me from letting people in, even when I want to'
            },
            {
              value: 'patterns',
              emoji: 'üîÑ',
              label: 'The same patterns keep repeating',
              desc:  'Arguments, distance, misunderstanding ‚Äî a cycle I can\'t break'
            },
            {
              value: 'unseen',
              emoji: 'üëª',
              label: 'I don\'t feel truly seen or understood',
              desc:  'People know a version of me, not the real thing'
            }
          ]
        },
        heavy: {
          text:    'When you say something feels heavy ‚Äî where does that show up most?',
          sub:     'Choose what resonates.',
          type:    'choice',
          options: [
            {
              value: 'no-meaning',
              emoji: 'üå´',
              label: 'My days feel empty or purposeless',
              desc:  'Going through the motions without a sense of why any of it matters'
            },
            {
              value: 'not-mine',
              emoji: 'üó∫',
              label: 'My life doesn\'t feel like mine',
              desc:  'Like I\'m living a script someone else wrote for me'
            },
            {
              value: 'flat',
              emoji: 'üìâ',
              label: 'I\'ve lost the things that used to matter',
              desc:  'Interests, energy, excitement ‚Äî something has gone flat'
            },
            {
              value: 'unfulfilled',
              emoji: 'üéØ',
              label: 'I have everything and still feel unfulfilled',
              desc:  'Success by every external measure ‚Äî but something is missing inside'
            }
          ]
        },
        growth: {
          text:    'What kind of growth are you most drawn to right now?',
          sub:     'Choose the direction that calls to you.',
          type:    'choice',
          options: [
            {
              value: 'self-knowledge',
              emoji: 'üîç',
              label: 'Understanding myself more deeply',
              desc:  'My patterns, my values, what actually drives me'
            },
            {
              value: 'emotional-range',
              emoji: 'üé®',
              label: 'Expanding my emotional range',
              desc:  'Feeling more, reacting less, relating to my emotions differently'
            },
            {
              value: 'relationships',
              emoji: 'ü§ù',
              label: 'Improving how I relate to others',
              desc:  'More genuine connection, better communication, less friction'
            },
            {
              value: 'intentional-life',
              emoji: 'üß≠',
              label: 'Living more deliberately',
              desc:  'Designing a life that actually reflects what I care about'
            }
          ]
        }
      },

      3: {
        text:    'How difficult is this feeling <em>right now</em>?',
        sub:     'Be honest. This helps us understand where to start.',
        type:    'choice',
        options: [
          {
            value: 'mostly-okay',
            emoji: 'üå§',
            label: 'Manageable ‚Äî there\'s room to breathe',
            desc:  'Hard sometimes but I\'m coping. Looking to grow, not survive'
          },
          {
            value: 'background',
            emoji: 'üå•',
            label: 'It\'s a low hum in the background',
            desc:  'Always there, affecting things, but not overwhelming'
          },
          {
            value: 'getting-harder',
            emoji: '‚õà',
            label: 'It\'s been getting harder lately',
            desc:  'The weight is increasing. I need something to shift'
          },
          {
            value: 'very-difficult',
            emoji: 'üÜò',
            label: 'Very difficult ‚Äî I\'m really struggling',
            desc:  'I need support now. This is hard to carry'
          }
        ]
      },

      4: {
        text:    'Have you worked on your mental health <em>before</em>?',
        sub:     'No judgment ‚Äî this helps us calibrate the language and pace.',
        type:    'choice',
        options: [
          {
            value: 'first-time',
            emoji: 'üå±',
            label: 'This is my first time trying anything like this',
            desc:  'I\'m new to this kind of inner work'
          },
          {
            value: 'tried-own',
            emoji: 'üìñ',
            label: 'I\'ve explored on my own ‚Äî books, podcasts, self-help',
            desc:  'Some familiarity but no formal support'
          },
          {
            value: 'therapy-helped',
            emoji: 'üí¨',
            label: 'I\'ve worked with a therapist ‚Äî it helped',
            desc:  'I have some foundation. Looking to build on it'
          },
          {
            value: 'therapy-didnt-fit',
            emoji: 'üîÑ',
            label: 'I\'ve tried therapy but it wasn\'t the right fit',
            desc:  'I want something I can work through on my own terms'
          }
        ]
      },

      5: {
        text:    'If InnerShadow could give you one thing ‚Äî what would it be?',
        sub:     'Write whatever comes first. There\'s no right answer. Nobody else will see this.',
        type:    'text',
        placeholder: 'A sense of calm. To stop reacting the way I do. To feel like myself again. To stop feeling so alone...'
      }
    };

    // Pathway descriptions for results screen
    const PATHWAY_DESCRIPTIONS = {
      emotional:  'For people who want to understand and work with their emotions ‚Äî not fight them.',
      identity:   'For people who want to know who they actually are beneath the roles and expectations.',
      connection: 'For people whose relationships don\'t feel as real or close as they want them to.',
      living:     'For people who want a life that feels inhabited, not just managed.'
    };

    // First module titles per pathway
    const FIRST_MODULE_TITLES = {
      emotional:  'What Emotions Actually Are',
      identity:   'The Self You Inherited',
      connection: 'Why Connection Is So Hard',
      living:     'A Good Life vs a Full Calendar'
    };


    // ================================================================
    // RENDER ENGINE
    // ================================================================

    function getQuestion() {
      if (currentStep === 2) {
        const q1Answer = answers[1];
        return QUESTIONS[2][q1Answer] || QUESTIONS[2].emotions;
      }
      return QUESTIONS[currentStep];
    }

    function renderQuestion() {
      const q     = getQuestion();
      const block = document.getElementById('questionBlock');

      // Animate out then in
      block.style.opacity   = '0';
      block.style.transform = 'translateY(12px)';

      setTimeout(() => {
        if (q.type === 'choice') {
          block.innerHTML = renderChoiceQuestion(q);
        } else {
          block.innerHTML = renderTextQuestion(q);
        }

        // Restore saved answer if exists
        if (answers[currentStep]) {
          if (q.type === 'choice') {
            selectOption(answers[currentStep], false);
          } else {
            const ta = document.getElementById('textAnswer');
            if (ta) ta.value = answers[currentStep];
            updateNextButton();
          }
        }

        block.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
        block.style.opacity    = '1';
        block.style.transform  = 'translateY(0)';

        // Bind textarea input
        const ta = document.getElementById('textAnswer');
        if (ta) {
          ta.addEventListener('input', updateNextButton);
          ta.addEventListener('keydown', e => {
            if (e.key === 'Enter' && e.metaKey) goNext();
          });
        }
      }, 150);

      // Update progress
      document.getElementById('stepNum').textContent = currentStep;
      document.getElementById('topProgress').style.width = (currentStep / 5 * 100) + '%';
      document.getElementById('backBtn').disabled  = currentStep === 1;
      selectedVal = answers[currentStep] || null;
      updateNextButton();
    }

    function renderChoiceQuestion(q) {
      const optionsHTML = q.options.map(opt => `
        <button
          class="option"
          data-value="${opt.value}"
          onclick="selectOption('${opt.value}')"
        >
          <span class="option__emoji">${opt.emoji}</span>
          <span class="option__body">
            <span class="option__label">${opt.label}</span>
            <span class="option__desc">${opt.desc}</span>
          </span>
          <span class="option__check">‚úì</span>
        </button>
      `).join('');

      return `
        <h2 class="question-text">${q.text}</h2>
        <p class="question-sub">${q.sub}</p>
        <div class="options">${optionsHTML}</div>
      `;
    }

    function renderTextQuestion(q) {
      return `
        <h2 class="question-text">${q.text}</h2>
        <p class="question-sub">${q.sub}</p>
        <div class="text-question">
          <textarea
            id="textAnswer"
            class="big-textarea"
            placeholder="${q.placeholder}"
            maxlength="500"
          ></textarea>

```
      <p class="textarea-hint">
        Take your time. This is just for you ‚Äî it helps us understand what you need.
      </p>
    </div>
  `;
}

function selectOption(value, animate = true) {
  // Deselect all
  document.querySelectorAll('.option').forEach(opt => {
    opt.classList.remove('option--selected');
  });

  // Select chosen
  const chosen = document.querySelector(`.option[data-value="${value}"]`);
  if (chosen) {
    chosen.classList.add('option--selected');
    if (animate) {
      chosen.style.transition = 'transform 0.15s ease';
    }
  }

  selectedVal = value;
  updateNextButton();

  // Auto-advance on choice questions after brief delay
  if (animate && currentStep < 5) {
    setTimeout(() => goNext(), 380);
  }
}

function updateNextButton() {
  const q    = getQuestion();
  const btn  = document.getElementById('nextBtn');
  let valid  = false;

  if (q.type === 'choice') {
    valid = !!selectedVal;
  } else {
    const ta  = document.getElementById('textAnswer');
    valid = ta ? ta.value.trim().length >= 3 : false;
  }

  btn.disabled    = !valid;
  btn.textContent = currentStep === 5 ? 'See my results' : 'Continue';
}


// ================================================================
// NAVIGATION
// ================================================================

function goNext() {
  const q = getQuestion();
  let value;

  if (q.type === 'choice') {
    if (!selectedVal) return;
    value = selectedVal;
  } else {
    const ta = document.getElementById('textAnswer');
    value = ta ? ta.value.trim() : '';
    if (value.length < 3) return;
  }

  answers[currentStep] = value;

  // Crisis override on Q3 ‚Äî acknowledge but don't block
  if (currentStep === 3 && value === 'very-difficult') {
    showCrisisAcknowledgement();
    return;
  }

  if (currentStep === 5) {
    processResults();
    return;
  }

  currentStep++;
  selectedVal = null;
  renderQuestion();
  UI.scrollToTop();
}

function goBack() {
  if (currentStep === 1) return;
  currentStep--;
  selectedVal = answers[currentStep] || null;
  renderQuestion();
  UI.scrollToTop();
}

// Crisis acknowledgement ‚Äî shown before continuing
function showCrisisAcknowledgement() {
  const block = document.getElementById('questionBlock');
  block.innerHTML = `
    <div style="animation: fade-in 0.3s ease-out">
      <div style="
        background: var(--red-bg-strong);
        border: 1px solid var(--red-border-strong);
        border-radius: 1.25rem;
        padding: 1.5rem;
        margin-bottom: 1.25rem;
      ">
        <div style="display:flex;align-items:center;gap:0.625rem;margin-bottom:0.875rem">
          <span style="font-size:1.5rem">üÜò</span>
          <h3 style="font-size:1.0625rem;font-weight:700;color:var(--text-red)">
            You said you're really struggling
          </h3>
        </div>
        <p style="font-size:0.9375rem;color:var(--text-secondary);line-height:1.7;margin-bottom:1.25rem">
          That took courage to admit. InnerShadow has tools that can help ‚Äî but if you're in crisis right now, please reach out to someone who can be there for you immediately.
        </p>
        <div style="display:flex;flex-direction:column;gap:0.5rem">
          <a href="tel:988" style="
            display:flex;align-items:center;justify-content:space-between;
            padding:0.875rem 1rem;
            background:rgba(220,38,38,0.15);
            border:1px solid var(--red-border);
            border-radius:0.75rem;
            text-decoration:none;
          ">
            <span style="font-size:0.9375rem;font-weight:600;color:var(--text-red)">988 Crisis Lifeline</span>
            <span style="font-size:0.8125rem;color:var(--text-muted)">Call or text</span>
          </a>
          <a href="sms:741741&body=HOME" style="
            display:flex;align-items:center;justify-content:space-between;
            padding:0.875rem 1rem;
            background:rgba(220,38,38,0.15);
            border:1px solid var(--red-border);
            border-radius:0.75rem;
            text-decoration:none;
          ">
            <span style="font-size:0.9375rem;font-weight:600;color:var(--text-red)">Crisis Text Line</span>
            <span style="font-size:0.8125rem;color:var(--text-muted)">Text HOME to 741741</span>
          </a>
        </div>
      </div>

      <div style="
        background:var(--teal-bg);
        border:1px solid var(--teal-border);
        border-radius:1rem;
        padding:1.125rem;
      ">
        <p style="font-size:0.9375rem;color:var(--text-secondary);line-height:1.7">
          <strong style="color:var(--text-teal)">InnerShadow will start you on Emotional Foundations</strong> ‚Äî the pathway most relevant to where you are. You can use the breathing and grounding tools in your toolkit at any time, no modules required.
        </p>
      </div>
    </div>
  `;

  // Update button to continue
  const nextBtn = document.getElementById('nextBtn');
  nextBtn.disabled    = false;
  nextBtn.textContent = 'Continue to question 4';
  nextBtn.onclick     = () => {
    // Override routing ‚Äî crisis always starts at emotional
    answers[3]  = 'very-difficult';
    currentStep = 4;
    selectedVal = null;
    nextBtn.onclick = goNext;
    renderQuestion();
    UI.scrollToTop();
  };
}


// ================================================================
// RESULTS
// ================================================================

async function processResults() {
  UI.showLoading('Working out your pathway...');

  // Derive pathway + levels
  const primaryPathway  = Assessment.getRoutedPathway(answers[1], answers[3]);
  const intensityLevel  = Assessment.getIntensityLevel(answers[3]);
  const experienceLevel = Assessment.getExperienceLevel(answers[4]);
  const reflectionBack  = Assessment.generateReflection({
    q1: answers[1],
    q2: answers[2],
    q3: answers[3],
    q5: answers[5]
  });

  // Save to Supabase
  try {
    await DB.saveAssessment(
      currentUser.id,
      answers,
      primaryPathway,
      intensityLevel,
      experienceLevel,
      reflectionBack
    );
  } catch (err) {
    console.error('Assessment save failed:', err);
    // Continue anyway ‚Äî don't block the user
  }

  UI.hideLoading();

  // Show results screen
  showResults(primaryPathway, reflectionBack);
}

function showResults(pathway, reflection) {
  // Hide question area + CTA
  document.getElementById('questionArea').style.display  = 'none';
  document.querySelector('.cta-area').style.display      = 'none';
  document.getElementById('topProgress').style.width     = '100%';

  // Populate results
  document.getElementById('pathwayEmoji').textContent   = PATHWAY_ICONS[pathway];
  document.getElementById('pathwayName').innerHTML      = formatPathwayName(pathway);
  document.getElementById('pathwaySub').textContent     = PATHWAY_DESCRIPTIONS[pathway];
  document.getElementById('reflectionText').textContent = reflection;
  document.getElementById('firstModuleTitle').textContent = FIRST_MODULE_TITLES[pathway];

  // Show results
  document.getElementById('resultsScreen').classList.add('results-screen--show');

  // Subtle celebration
  setTimeout(() => UI.celebrate({ count: 50, spread: 50, origin: { y: 0.4 } }), 400);
}

function formatPathwayName(pathway) {
  const names = {
    emotional:  'Emotional <em>Foundations</em>',
    identity:   'Knowing <em>Yourself</em>',
    connection: '<em>Connection</em>',
    living:     'Living <em>Well</em>'
  };
  return names[pathway] || pathway;
}

async function handleStart() {
  const btn = document.getElementById('startBtn');
  btn.disabled    = true;
  btn.textContent = 'Starting...';

  // Get their pathway from saved assessment
  try {
    const { data } = await DB.getUserState(currentUser.id);
    const pathway  = data?.primary_pathway || 'emotional';
    const firstModule = PATHWAY_MODULES[pathway][0];
    Nav.go(`/pathways/${pathway.slice(0,2) === 'em' ? 'emotional' : pathway}/${firstModule}.html`, 'Loading your first module...');
  } catch (err) {
    Nav.go('/app.html', 'Loading...');
  }
}


// ================================================================
// INIT
// ================================================================

async function init() {
  const session = await Auth.requireAuth('/index.html');
  if (!session) return;

  currentUser = session.user;

  // Already completed? Go straight to app
  try {
    const { data } = await DB.getUserState(currentUser.id);
    if (data?.assessment_completed) {
      Nav.go('/app.html', 'Welcome back...');
      return;
    }
  } catch (err) {
    // Continue to assessment on error
  }

  renderQuestion();
  UI.markLoaded();
}

document.addEventListener('DOMContentLoaded', init);
```

  </script>

  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/sw.js').catch(() => {});
    }
  </script>

</body>
</html>
